<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .view { display: none; } /* Oculta todas las vistas por defecto */
        .view.active { display: block; } /* Muestra la vista activa */
        .btn-menu { padding: 15px 30px; margin: 10px; font-size: 1.1em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: background-color 0.3s; }
        .btn-menu:hover { background-color: #0056b3; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="password"] { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .btn-action { padding: 10px 20px; margin-right: 10px; cursor: pointer; border: none; border-radius: 4px; color: white; }
        .btn-primary { background-color: #28a745; }
        .btn-primary:hover { background-color: #1e7e34; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .total-row { font-weight: bold; background-color: #e9ecef; }
        #loginForm { display: flex; flex-direction: column; gap: 10px; max-width: 300px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="loginView" class="view active">
            <h1>Acceso</h1></label>
            <h1>Software Gestion TMV</h1>
            <form id="loginForm">
                <label for="username">Usuario:</label>
                <input type="text" id="username" required>
                <label for="password">Contraseña:</label>
                <input type="password" id="password" required>
                <button type="submit" class="btn-menu">Entrar</button>
                <p id="loginMessage" style="color: red; text-align: center;"></p>
            </form>
            <h1>Aislamiento tributario</h1></label>
            <h1>copyright 2025 TMV</h1>
        </div>

        <div id="mainMenuView" class="view">
            <h1>Menú Principal</h1>
            <button class="btn-menu" onclick="showView('budgetFormView')">Presupuestos</button>
            <button class="btn-menu" onclick="showView('deliveryNoteView')">Albaranes</button>
            <button class="btn-menu" onclick="showView('invoiceView')">Facturas</button>
            <button class="btn-menu" onclick="showView('listView')">Listados</button>
        </div>

        <div id="budgetFormView" class="view">
            <h2>Crear Presupuesto</h2>

            <h2>Datos Comerciales</h2>
        <div id="cliente-cif-group">
            <div><label for="cliente-nombre">Nombre del Cliente:</label><input type="text" id="cliente-nombre" required></div>
            <div><label for="cliente-cif">CIF:</label><input type="text" id="cliente-cif" required></div>
        </div>
        <div class="input-group">
            <div><label for="cliente-direccion">Dirección:</label><input type="text" id="cliente-direccion" required></div>
            <div><label for="cliente-cp">Código Postal:</label><input type="text" id="cliente-cp" required></div>
            <div><label for="cliente-ciudad">Ciudad:</label><input type="text" id="cliente-ciudad" required></div>
            <div><label for="cliente-provincia">Provincia:</label><input type="text" id="cliente-provincia" required></div>
        </div>

            <h3>Líneas de Concepto</h3>
            <table id="conceptTable">
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>Unidades</th>
                        <th>Precio Unidad (€)</th>
                        <th>Total Línea (€)</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            <br>
            <button class="btn-action btn-secondary" onclick="addLine()">Añadir Línea</button>

            <h3>Totales</h3>
            <table>
                <tr class="total-row"><td>Base Imponible (100%)</td><td id="base_imponible_display">0.00 €</td></tr>
                <tr class="total-row"><td>IVA (21%)</td><td id="iva_display">0.00 €</td></tr>
                <tr class="total-row"><td>TOTAL (+ IVA)</td><td id="total_final_display">0.00 €</td></tr>
            </table>
            <br>

            <button class="btn-action btn-primary" onclick="window.print()">Imprimir Presupuesto</button>
            <button class="btn-action btn-secondary" onclick="alert('Funcionalidad de Guardar no implementada')">Guardar Presupuesto</button>
            <button class="btn-action btn-secondary" onclick="alert('Funcionalidad de Convertir a PDF no implementada')">Convertir a PDF</button>
            <button class="btn-action btn-secondary" onclick="showView('mainMenuView')">Salir</button>
        </div>

        <div id="deliveryNoteView" class="view">
            <h2>Gestión de Albaranes</h2>
            <p>Aquí iría el formulario de Albaranes, similar al de Presupuestos.</p>
            <button class="btn-action btn-secondary" onclick="showView('mainMenuView')">Salir</button>
        </div>

        <div id="invoiceView" class="view">
            <h2>Gestión de Facturas</h2>
            <p>Aquí iría el formulario de Facturas, similar al de Presupuestos.</p>
            <button class="btn-action btn-secondary" onclick="showView('mainMenuView')">Salir</button>
        </div>

        <div id="listView" class="view">
            <h2>Listados</h2>
            <p>Opción de ver listados, no implementada en detalle.</p>
            <button class="btn-menu" onclick="showView('mainMenuView')">Salir</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACIÓN DE USUARIOS ---
        const USERS = {
            "tmvinfo": "1234",
            "cliente": "cliente"
        };
        const IVA_PERCENTAGE = 0.21;

        // --- 2. GESTIÓN DE VISTAS (NAVEGACIÓN) ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }

        // --- 3. LÓGICA DE LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const message = document.getElementById('loginMessage');

            if (USERS[username] === password) {
                message.textContent = '';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showView('mainMenuView');
            } else {
                message.textContent = 'Usuario o contraseña incorrectos.';
            }
        });

        // --- 4. LÓGICA DE PRESUPUESTOS ---
        const conceptTableBody = document.querySelector('#conceptTable tbody');
        let lineCounter = 0;

        // Función para añadir una nueva línea de concepto
        function addLine() {
            lineCounter++;
            const row = conceptTableBody.insertRow();
            row.id = 'line-' + lineCounter;

            row.innerHTML = `
                <td><input type="text" name="concept" required></td>
                <td><input type="number" name="units" min="1" value="1" oninput="calculateLineTotal(${lineCounter})" required></td>
                <td><input type="number" name="price" min="0" step="0.01" value="0.00" oninput="calculateLineTotal(${lineCounter})" required></td>
                <td id="total-line-${lineCounter}">0.00</td>
                <td><button class="btn-action btn-secondary" onclick="removeLine(${lineCounter})">Eliminar</button></td>
            `;

            // Calcular el total de la nueva línea inmediatamente (aunque sea 0)
            calculateLineTotal(lineCounter);
        }

        // Función para calcular el total de una línea específica
        function calculateLineTotal(lineId) {
            const row = document.getElementById('line-' + lineId);
            if (!row) return;

            const unitsInput = row.querySelector('input[name="units"]');
            const priceInput = row.querySelector('input[name="price"]');
            const lineTotalCell = document.getElementById('total-line-' + lineId);

            const units = parseFloat(unitsInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;

            const lineTotal = units * price;
            lineTotalCell.textContent = lineTotal.toFixed(2);

            calculateFinalTotals();
        }

        // Función para eliminar una línea de concepto
        function removeLine(lineId) {
            const row = document.getElementById('line-' + lineId);
            if (row) {
                row.remove();
                calculateFinalTotals();
            }
        }

        // Función para calcular Base Imponible, IVA y Total Final
        function calculateFinalTotals() {
            let baseImponible = 0;
            const totalCells = document.querySelectorAll('[id^="total-line-"]');

            totalCells.forEach(cell => {
                baseImponible += parseFloat(cell.textContent) || 0;
            });

            const ivaAmount = baseImponible * IVA_PERCENTAGE;
            const totalFinal = baseImponible + ivaAmount;

            document.getElementById('base_imponible_display').textContent = baseImponible.toFixed(2) + ' €';
            document.getElementById('iva_display').textContent = ivaAmount.toFixed(2) + ' €';
            document.getElementById('total_final_display').textContent = totalFinal.toFixed(2) + ' €';
        }

        // Inicializar con la primera línea de concepto al cargar la vista
        window.onload = addLine; // Añade una línea al cargar la página
    </script>

</body>
</html>
