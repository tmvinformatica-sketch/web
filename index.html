<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="styles.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 900px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .view { display: none; } /* Oculta todas las vistas por defecto */
        .view.active { display: block; } /* Muestra la vista activa */
        .btn-menu { padding: 15px 30px; margin: 10px; font-size: 1.1em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: background-color 0.3s; }
        .btn-menu:hover { background-color: #0056b3; }
        
        /* Estilos Flexbox para agrupar campos en una línea */
        .form-row { display: flex; gap: 20px; margin-bottom: 10px; }
        .form-group { flex: 1; /* Distribuye el espacio equitativamente */ }
        .form-group.w-25 { flex: 0 0 25%; /* Para campos más pequeños como CP */ }
        .form-group.w-50 { flex: 0 0 50%; }

        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"], input[type="password"], input[type="date"], select { 
            width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; 
        }
        
        /* Estilos de tabla y botones */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .btn-action { padding: 10px 20px; margin-right: 10px; cursor: pointer; border: none; border-radius: 4px; color: white; }
        .btn-primary { background-color: #28a745; }
        .btn-primary:hover { background-color: #1e7e34; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .total-row { font-weight: bold; background-color: #e9ecef; }
        #loginForm { display: flex; flex-direction: column; gap: 10px; max-width: 300px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="loginView" class="view active">
            <h1 style="text-align: center;">Ascceso al Sistema</h1>
    <p style="text-align: center;">Software Facturación Electronica</p>
            <form id="loginForm">
                <label for="username">Usuario:</label>
                <input type="text" id="username" required>
                <label for="password">Contraseña:</label>
                <input type="password" id="password" required>
                <button type="submit" class="btn-menu">Entrar</button>
                <p id="loginMessage" style="color: red; text-align: center;"></p>
            </form>
            <h1 style="text-align: center;"></h1>
    <p style="text-align: center;">Copyright 20025 TMV</p>
        </div>

        <div id="mainMenuView" class="view">
            <h1 style="text-align: center;">Facturación Electronica TMV</h1>
            <center>
            <img src="LogoTmv.jpg" alt="Tmv Informatica">    
            </center>
            

            <button class="btn-menu" onclick="showDocumentForm('budget')">Presupuestos</button>
            <button class="btn-menu" onclick="showDocumentForm('deliveryNote')">Albaranes</button>
            <button class="btn-menu" onclick="showDocumentForm('invoice')">Facturas</button>
            <button class="btn-menu" onclick="showView('listView')">Control Horario</button>
            <button class="btn-menu" onclick="showView('listView')">Listados</button>
        </div>

        <div id="documentFormView" class="view">
            <h2 id="documentTitle"></h2>

            
            <div class="form-row">
                <div class="form-group">
                    <label for="doc_date">Fecha:</label>
                    <input type="date" id="doc_date" value="">
                </div>
                <div class="form-group w-25">
                    <label id="docNumberLabel" for="doc_number">Nº Documento:</label>
                    <input type="text" id="doc_number" value="" placeholder="Ej: PRP-001">
                </div>
                <div class="form-group">
                    <label for="payment_method">Forma de Pago:</label>
                    <select id="payment_method">
                        <option value="contado">Al Contado</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="entrega">Entrega a Cuenta</option>
                    </select>
                </div>
            </div>

            <h3>Datos del Cliente</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="cli_name">Nombre Cliente:</label>
                    <input type="text" id="cli_name">
                </div>
                <div class="form-group w-25">
                    <label for="cli_cif">CIF:</label>
                    <input type="text" id="cli_cif">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="cli_address">Dirección:</label>
                    <input type="text" id="cli_address">
                </div>
                <div class="form-group w-25">
                    <label for="cli_zip">C.P.:</label>
                    <input type="text" id="cli_zip">
                </div>
                <div class="form-group">
                    <label for="cli_city">Población / Provincia:</label>
                    <input type="text" id="cli_city" placeholder="Población">
                </div>
                <div class="form-group">
                    <input type="text" id="cli_province" placeholder="Provincia">
                </div>
            </div>
            
            <h3>Líneas de Concepto</h3>
            <table id="conceptTable">
                <thead>
                    <tr>
                        <th>Concepto</th>
                        <th>Unidades</th>
                        <th>Precio Unidad (€)</th>
                        <th>Total Línea (€)</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="conceptTableBody">
                    </tbody>
            </table>
            <br>
            <button class="btn-action btn-secondary" onclick="addLine()">Añadir Línea</button>

            <h3>Totales</h3>
            <table>
                <tr class="total-row"><td>Base Imponible (100%)</td><td id="base_imponible_display">0.00 €</td></tr>
                <tr class="total-row"><td>IVA (21%)</td><td id="iva_display">0.00 €</td></tr>
                <tr class="total-row"><td>TOTAL (+ IVA)</td><td id="total_final_display">0.00 €</td></tr>
            </table>
            <br>

            <button class="btn-action btn-primary" id="btnPrint" onclick="window.print()"></button>
            <button class="btn-action btn-secondary" onclick="alert('Funcionalidad de Guardar no implementada')">Guardar Documento</button>
            <button class="btn-action btn-secondary" onclick="alert('Funcionalidad de Convertir a PDF no implementada')">Convertir a PDF</button>
            <button class="btn-action btn-secondary" onclick="showView('mainMenuView')">Salir</button>
        </div>

        <div id="listView" class="view">
            <h2>Listados</h2>
            <p>Opción de ver listados.</p>
            <button class="btn-menu" onclick="showView('mainMenuView')">Salir</button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACIÓN DE USUARIOS y CONSTANTES ---
        const USERS = {
            "tmvinfo": "1234",
            "cliente": "cliente"
        };
        const IVA_PERCENTAGE = 0.21;
        const DOC_CONFIG = {
            'budget': { title: 'Presupuesto', prefix: 'PRP', printText: 'Imprimir Presupuesto' },
            'deliveryNote': { title: 'Albarán', prefix: 'ALB', printText: 'Imprimir Albarán' },
            'invoice': { title: 'Factura', prefix: 'FAC', printText: 'Imprimir Factura' }
        };

        // --- 2. GESTIÓN DE VISTAS (NAVEGACIÓN) ---
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }

        /**
         * Muestra el formulario de documento (Presupuesto, Albarán o Factura)
         * @param {string} docType - 'budget', 'deliveryNote', o 'invoice'
         */
        function showDocumentForm(docType) {
            const config = DOC_CONFIG[docType];
            
            // 1. Actualiza los textos dinámicos
            document.getElementById('documentTitle').textContent = config.title;
            document.getElementById('docNumberLabel').textContent = `Nº ${config.title.split(' ')[1]}:`;
            document.getElementById('doc_number').value = `${config.prefix}-001`;
            document.getElementById('doc_number').placeholder = `Ej: ${config.prefix}-001`;
            document.getElementById('btnPrint').textContent = config.printText;

            // 2. Reinicia los conceptos de la tabla
            document.getElementById('conceptTableBody').innerHTML = '';
            addLine(); // Añade una línea inicial
            
            // 3. Establece la fecha actual
            setTodayDate();

            // 4. Muestra la vista
            showView('documentFormView');
        }

        // --- 3. LÓGICA DE LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const message = document.getElementById('loginMessage');

            if (USERS[username] === password) {
                message.textContent = '';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showView('mainMenuView');
            } else {
                message.textContent = 'Usuario o contraseña incorrectos.';
            }
        });

        // --- 4. LÓGICA DE CÁLCULO DEL DOCUMENTO ---
        const conceptTableBody = document.getElementById('conceptTableBody');
        let lineCounter = 0;

        // Función para establecer la fecha actual por defecto
        function setTodayDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Enero es 0!
            const year = today.getFullYear();
            document.getElementById('doc_date').value = `${year}-${month}-${day}`;
        }

        // Función para añadir una nueva línea de concepto
        function addLine() {
            lineCounter++;
            const row = conceptTableBody.insertRow();
            row.id = 'line-' + lineCounter;

            row.innerHTML = `
                <td><input type="text" name="concept" required></td>
                <td><input type="number" name="units" min="1" value="1" oninput="calculateLineTotal(${lineCounter})" required></td>
                <td><input type="number" name="price" min="0" step="0.01" value="0.00" oninput="calculateLineTotal(${lineCounter})" required></td>
                <td id="total-line-${lineCounter}">0.00</td>
                <td><button class="btn-action btn-secondary" onclick="removeLine(${lineCounter})">Eliminar</button></td>
            `;
            calculateLineTotal(lineCounter); // Recalcula totales
        }

        // Función para calcular el total de una línea específica
        function calculateLineTotal(lineId) {
            const row = document.getElementById('line-' + lineId);
            if (!row) return;

            const unitsInput = row.querySelector('input[name="units"]');
            const priceInput = row.querySelector('input[name="price"]');
            const lineTotalCell = document.getElementById('total-line-' + lineId);

            const units = parseFloat(unitsInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;

            const lineTotal = units * price;
            lineTotalCell.textContent = lineTotal.toFixed(2);

            calculateFinalTotals();
        }

        // Función para eliminar una línea de concepto
        function removeLine(lineId) {
            const row = document.getElementById('line-' + lineId);
            if (row) {
                row.remove();
                calculateFinalTotals();
            }
        }

        // Función para calcular Base Imponible, IVA y Total Final
        function calculateFinalTotals() {
            let baseImponible = 0;
            // Busca las celdas de total de línea dentro del body de la tabla
            const totalCells = document.querySelectorAll('#conceptTableBody [id^="total-line-"]');

            totalCells.forEach(cell => {
                baseImponible += parseFloat(cell.textContent) || 0;
            });

            const ivaAmount = baseImponible * IVA_PERCENTAGE;
            const totalFinal = baseImponible + ivaAmount;

            document.getElementById('base_imponible_display').textContent = baseImponible.toFixed(2) + ' €';
            document.getElementById('iva_display').textContent = ivaAmount.toFixed(2) + ' €';
            document.getElementById('total_final_display').textContent = totalFinal.toFixed(2) + ' €';
        }

        // Inicializar la aplicación
        window.onload = function() {
            // No iniciamos con un formulario de documento, sino con el login.
            // setTodayDate() y addLine() se llaman dentro de showDocumentForm().
        };
    </script>

</body>
</html>
